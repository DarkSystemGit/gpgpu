(function(a,b){'object'==typeof exports&&'undefined'!=typeof module?b(exports):'function'==typeof define&&define.amd?define(['exports'],b):b(a.blink=a.blink||{})})(this,function(a){'use strict';function b(a,b=1){const{bytes:c,integer:d,unsigned:e}=a,f=['lowp','mediump',null,'highp'][c-1],g=d&&e?'usampler2D':d?'isampler2D':'sampler2D';let h=null;1==b?h=d&&e?'uint':d?'int':'float':(h=d&&e?'uvec':d?'ivec':'vec',h+=b);let i=['R','RG','RGB','RGBA'][b-1];i+=8*c,i+=d&&e?'UI':d?'I':'F';let j=['RED','RG','RGB','RGBA'][b-1];j+=d?'_INTEGER':'';let k='';return d?(e&&(k='UNSIGNED_'),k+=1==c?'BYTE':2==c?'SHORT':'INT'):k='FLOAT',{bytes:c,format:j,internalFormat:i,inputType:g,integer:d,outputType:h,precision:f,type:k,unsigned:e}}function c(a){let b=Math.floor(Math.sqrt(a));for(;a%b&&1<b;)b-=1;return[b,a/b]}function d(a){let b=j.getParameter(j.FRAMEBUFFER_BINDING),c=j.createFramebuffer();j.bindFramebuffer(j.FRAMEBUFFER,c),a(),j.bindFramebuffer(j.FRAMEBUFFER,b),j.deleteFramebuffer(c)}function e(a,b=null){const{bytes:c,internalFormat:d,format:e,type:f}=a.formatInfo,[g,h]=a.dimensions;return new y(d,g,h,e,f,b,c,...a.wrap)}function f(a,b){/^#version 300 es/g.test(b)||(b='#version 300 es\n\r'+b);let c=j.createShader(a);if(j.shaderSource(c,b),j.compileShader(c),!j.getShaderParameter(c,j.COMPILE_STATUS)){const b=a==j.VERTEX_SHADER?'vertex':'fragment',d=j.getShaderInfoLog(c);throw new Error(`Unable to compile ${b} shader. Info log: 
			${d}`)}return c}function g(a,b,c){let d=Object.entries(a).map(([a,b])=>{const{inputType:c,precision:d}=b.formatInfo;return`uniform ${d} ${c} ${a};`}),e=Object.entries(b).map(([a,b])=>{const c=b.location===void 0?'':`layout(location = ${b.location}) out `;return`${c}${b.precision} ${b.outputType} ${a};`});return`${H}

		${d.join('\n\r')}

		${e.join('\n\r')}

		${c}`}var h=Math.min,i=Math.max;const j=function(){const a=document.createElement('canvas');a.width=a.height=1;let b=a.getContext('webgl2',{alpha:!1,antialias:!1,depth:!1,stencil:!1});if(!b)throw new Error('WebGL 2.0 not supported by the browser.');else if(!(b.floatExt=b.getExtension('EXT_color_buffer_float')))throw new Error('EXT_color_buffer_float not supported.');return b.pixelStorei(b.PACK_ALIGNMENT,1),b.pixelStorei(b.UNPACK_ALIGNMENT,1),b}(),k=function(){let a={};const b={debugRendererInfo:'WEBGL_debug_renderer_info',debugShaders:'WEBGL_debug_shaders',getBufferSubDataAsync:'WEBGL_get_buffer_sub_data_async'};for(const[c,d]of Object.entries(b)){let b=j.getExtension(d);b&&(a[c]=b)}return a}(),l=function(){let a={glslVersion:j.getParameter(j.SHADING_LANGUAGE_VERSION),maxColorAttachments:j.getParameter(j.MAX_DRAW_BUFFERS),maxTextureSize:j.getParameter(j.MAX_TEXTURE_SIZE),maxTextureUnits:j.getParameter(j.MAX_TEXTURE_IMAGE_UNITS),renderer:j.getParameter(j.RENDERER),vendor:j.getParameter(j.VENDOR)},{debugRendererInfo:b}=k;return b&&(a.unmaskedRenderer=j.getParameter(b.UNMASKED_RENDERER_WEBGL),a.unmaskedVendor=j.getParameter(b.UNMASKED_VENDOR_WEBGL)),Object.freeze(a)}(),m=function(){const a=new Float32Array([-1,1,-1,-1,1,1,1,-1]);let b=j.createBuffer();j.bindBuffer(j.ARRAY_BUFFER,b),j.bufferData(j.ARRAY_BUFFER,a,j.STATIC_DRAW),j.bindBuffer(j.ARRAY_BUFFER,null);let c=j.createVertexArray();return j.bindVertexArray(c),j.bindBuffer(j.ARRAY_BUFFER,b),j.enableVertexAttribArray(0),j.vertexAttribPointer(0,2,j.FLOAT,!1,0,0),j.bindVertexArray(null),j.bindBuffer(j.ARRAY_BUFFER,null),c}(),n=(a,b,c,d)=>Object.freeze({name:a,bytes:b,integer:c,unsigned:d}),o=n('float',4,!1,!1),p=n('int32',4,!0,!1),q=n('int16',2,!0,!1),r=n('int8',1,!0,!1),s=n('uint32',4,!0,!0),t=n('uint16',2,!0,!0),u=n('uint8',1,!0,!0),v=33071,w=new Map([[o,Float32Array],[p,Int32Array],[q,Int16Array],[r,Int8Array],[s,Uint32Array],[t,Uint16Array],[u,Uint8Array]]),x=new Map([[Float32Array,o],[Int32Array,p],[Int16Array,q],[Int8Array,r],[Uint32Array,s],[Uint16Array,t],[Uint8Array,u],[Uint8ClampedArray,u]]);class y{constructor(a,b,c,d,e,f,g,h,i){const k=j.getParameter(j.TEXTURE_BINDING_2D);this.internalFormat=a,this.width=b,this.height=c,this.format=d,this.type=e,this.alignment=g,this.id=j.createTexture(),j.bindTexture(j.TEXTURE_2D,this.id),j.texParameteri(j.TEXTURE_2D,j.TEXTURE_WRAP_S,h||j.CLAMP_TO_EDGE),j.texParameteri(j.TEXTURE_2D,j.TEXTURE_WRAP_T,i||j.CLAMP_TO_EDGE),j.texParameteri(j.TEXTURE_2D,j.TEXTURE_MIN_FILTER,j.NEAREST),j.texParameteri(j.TEXTURE_2D,j.TEXTURE_MAG_FILTER,j.NEAREST),j.texImage2D(j.TEXTURE_2D,0,j[this.internalFormat],b,c,0,j[this.format],j[this.type],f),j.bindTexture(j.TEXTURE_2D,k)}delete(){j.getParameter(j.TEXTURE_BINDING_2D)==this.id&&j.bindTexture(j.TEXTURE_2D,null),j.deleteTexture(this.id),delete this.id}copy(){let a=new y(this.internalFormat,this.width,this.height,this.format,this.type,null,this.alignment);return d(()=>{j.framebufferTexture2D(j.FRAMEBUFFER,j.COLOR_ATTACHMENT0,j.TEXTURE_2D,this.id,0),j.readBuffer(j.COLOR_ATTACHMENT0),j.bindTexture(j.TEXTURE_2D,a.id),j.copyTexSubImage2D(j.TEXTURE_2D,0,0,0,0,0,this.width,this.height,0),j.bindTexture(j.TEXTURE_2D,null)}),a}upload(a){return j.bindTexture(j.TEXTURE_2D,this.id),j.texImage2D(j.TEXTURE_2D,0,j[this.internalFormat],this.width,this.height,0,j[this.format],j[this.type],a),j.bindTexture(j.TEXTURE_2D,null),this}read(a){return d(()=>{j.framebufferTexture2D(j.FRAMEBUFFER,j.COLOR_ATTACHMENT0,j.TEXTURE_2D,this.id,0),j.readBuffer(j.COLOR_ATTACHMENT0),j.readPixels(0,0,this.width,this.height,j[this.format],j[this.type],a,0)}),!0}readAsync(a){return new Promise((b,c)=>{d(()=>{j.framebufferTexture2D(j.FRAMEBUFFER,j.COLOR_ATTACHMENT0,j.TEXTURE_2D,this.id,0),j.readBuffer(j.COLOR_ATTACHMENT0);let d=j.createBuffer();j.bindBuffer(j.PIXEL_PACK_BUFFER,d),j.bufferData(j.PIXEL_PACK_BUFFER,a.byteLength,j.STATIC_READ),j.readPixels(0,0,this.width,this.height,j[this.format],j[this.type],0);const e=()=>{j.bindBuffer(j.PIXEL_PACK_BUFFER,null),j.deleteBuffer(d)},f=k.getBufferSubDataAsync;f.getBufferSubDataAsync(j.PIXEL_PACK_BUFFER,0,a,0,0).then(()=>{e(),b(a)}).catch((a)=>{e(),c(a)})})})}}let z=new WeakMap,A=new WeakMap;class B{constructor({alloc:a,data:b,type:d=o,vector:e=1,wrap:f=v}){this.vector=h(i(e,1),4),3==this.vector&&(console.warn('Vector size of 3 not supported. Choosing vector size 4.'),this.vector=4);let g=a||b.length;this.dimensions=c(g/this.vector),this.wrap=Array.isArray(f)?f:[f,f];const j=l.maxTextureSize**2;if(i(...this.dimensions)>j)throw new Error('Buffer size exceeds device limit.');if(null!=a){const a=w.get(d);this.data=new a(g)}else this.data=b instanceof Uint8ClampedArray?new Uint8Array(b.buffer):b}delete(){delete this.data,this._finish()}copy(){return new B({data:new this.data.constructor(this.data),vector:this.vector})}get formatInfo(){for(const[a,c]of x)if(this.data instanceof a)return b(c,this.vector);return null}_getReadable(a=!1){if(!z.has(this)&&a){const a=e(this,this.data);z.set(this,a)}return z.get(this)}_getWritable(a=!1){if(!A.has(this)&&a){const a=e(this,this.data);A.set(this,a)}return A.get(this)}_finish(){let a=this._getReadable();a&&(a.delete(),z.delete(this));let b=this._getWritable();b&&(b.delete(),A.delete(this))}}class C{constructor({alloc:a,data:b,type:d=o,vector:e=1,wrap:f=v}){this.vector=h(i(e,1),4),3==this.vector&&(console.warn('Vector size of 3 not supported. Choosing vector size 4.'),this.vector=4),this.size=a||b.length,this.dimensions=c(this.size/this.vector),this.wrap=Array.isArray(f)?f:[f,f];const g=l.maxTextureSize**2;if(i(...this.dimensions)>g)throw new Error('Buffer size exceeds device limit.');let j=d;if(b)for(const[a,c]of x)if(b instanceof a){j=c;break}this.type=j;let k=this._getReadable(!0);b&&(b.constructor==Uint8ClampedArray&&(b=new Uint8Array(b.buffer)),k.upload(b))}delete(){z.has(this)&&(z.get(this).delete(),z.delete(this))}copy(){let a=this._readable.copy(),b=new C({alloc:this.size,type:this.type,vector:this.vector});return b._readable.delete(),b._readable=a,b}toDevice(a){this._getReadable().upload(a)}toHost(a){return a=this._prepareLocalData(a),this._getReadable().read(a),a}get formatInfo(){return b(this.type,this.vector)}_getReadable(a=!1){if(!z.has(this)&&a){const{bytes:a,internalFormat:b,format:c,type:d}=this.formatInfo,[e,f]=this.dimensions;z.set(this,new y(b,e,f,c,d,null,a,...this.wrap))}return z.get(this)}_getWritable(a=!1){return!A.has(this)&&a&&A.set(this,this._getReadable(!0).copy()),A.get(this)}_finish(){let a=this._getWritable();if(a){let b=this._getReadable();b&&b.delete(),z.set(this,a),A.delete(this)}}_prepareLocalData(a){if(!a){const b=w.get(this.type);a=new b(this.size)}let b=a;return a instanceof Uint8ClampedArray&&(b=new Uint8Array(a.buffer)),b}}k.getBufferSubDataAsync&&(C.prototype.toHostAsync=function(a){return a=this._prepareLocalData(a),this._getReadable().readAsync(a)});var D=`#version 300 es

precision highp float;

layout(location = 0) in vec2 pos;
out vec2 bl_UV;

void main() {
	gl_Position = vec4(pos, 0.0, 1.0);
	bl_UV = pos * 0.5 + 0.5;
}`;const E=f(j.VERTEX_SHADER,D);class F{constructor(a){let b=f(j.FRAGMENT_SHADER,a);if(this.id=j.createProgram(),j.attachShader(this.id,E),j.attachShader(this.id,b),j.deleteShader(b),j.linkProgram(this.id),!j.getProgramParameter(this.id,j.LINK_STATUS))return console.error('Unable to link program. Info log:'),console.warn(j.getProgramInfoLog(this.id)),null;this.attributes={};const c=j.getProgramParameter(this.id,j.ACTIVE_ATTRIBUTES);for(let b,d=0;d<c;d++)b=j.getActiveAttrib(this.id,d),b.id=j.getAttribLocation(this.id,b.name),this.attributes[b.name]=b;this.uniforms={};const d=j.getProgramParameter(this.id,j.ACTIVE_UNIFORMS);for(let b,c=0;c<d;c++)b=j.getActiveUniform(this.id,c),b.id=j.getUniformLocation(this.id,b.name),this.uniforms[b.name]=b}delete(){j.deleteProgram(this.id),delete this.id}setUniform(a,...b){if(!this.uniforms[a])return;const{id:c,size:d,type:e}=this.uniforms[a];let f=G[e];1<d&&'v'!=f[f.length-1]&&(f+='v'),-1==f.indexOf('Matrix')?j[f](c,...b):j[f](c,!1,...b)}}const G={[j.FLOAT]:'uniform1f',[j.FLOAT_VEC2]:'uniform2f',[j.FLOAT_VEC3]:'uniform3f',[j.FLOAT_VEC4]:'uniform4f',[j.INT]:'uniform1i',[j.INT_VEC2]:'uniform2i',[j.INT_VEC3]:'uniform3i',[j.INT_VEC4]:'uniform4i',[j.UNSIGNED_INT]:'uniform1ui',[j.UNSIGNED_INT_VEC2]:'uniform2ui',[j.UNSIGNED_INT_VEC3]:'uniform3ui',[j.UNSIGNED_INT_VEC4]:'uniform4ui',[j.BOOL]:'uniform1i',[j.BOOL_VEC2]:'uniform2i',[j.BOOL_VEC3]:'uniform3i',[j.BOOL_VEC4]:'uniform4i',[j.FLOAT_MAT2]:'uniformMatrix2fv',[j.FLOAT_MAT2x3]:'uniformMatrix2x3fv',[j.FLOAT_MAT2x4]:'uniformMatrix2x4fv',[j.FLOAT_MAT3]:'uniformMatrix3fv',[j.FLOAT_MAT3x2]:'uniformMatrix3x2fv',[j.FLOAT_MAT3x4]:'uniformMatrix3x4fv',[j.FLOAT_MAT4]:'uniformMatrix4fv',[j.FLOAT_MAT4x2]:'uniformMatrix4x2fv',[j.FLOAT_MAT4x3]:'uniformMatrix4x3fv',[j.SAMPLER_2D]:'uniform1i',[j.INT_SAMPLER_2D]:'uniform1i',[j.UNSIGNED_INT_SAMPLER_2D]:'uniform1i'};var H=`#version 300 es

precision highp float;
precision highp int;

uniform highp ivec2 bl_Size;

in vec2 bl_UV;

highp uint bl_Id() {
	highp ivec2 uv = ivec2(bl_UV * vec2(bl_Size));
	return uint(uv.x + uv.y * bl_Size.x);
}`;const I={major:0,minor:3,patch:0,toString(){return`${this.major}.${this.minor}.${this.patch}`}};a.VERSION=I,a.device=l,a.context=j,a.Buffer=B,a.DeviceBuffer=C,a.Kernel=class{constructor(a,b){if(this.inputs=a.in||a.input||a.inputs||{},this.outputs=a.out||a.output||a.outputs,!this.outputs||!Object.values(this.outputs).length)throw new Error(`At least 1 output is required.`);for(const c of Object.keys(this.outputs))for(const a of Object.keys(this.inputs))if(a===c)throw new Error(`Conflicting input/output variable name: ${a}.`);let c=Object.values(this.inputs).length;if(c>l.maxTextureUnits)throw new Error(`Maximum number of inputs exceeded. Allowed: ${l.maxTextureUnits}, given: ${c}.`);const d=l.maxColorAttachments,e=Object.keys(this.outputs),f=Math.ceil(e.length/d);let h=[],j=0;for(let c,g=0;g<f;g++){c={};for(const[a,b]of e.entries()){const{outputType:e,precision:f}=this.outputs[b].formatInfo;c[b]={outputType:e,precision:f},a>=j&&a<j+d&&(c[b].location=a-j)}h.push(c),j+=d}this.steps=new Set(h.map((a)=>{const c=g(this.inputs,a,b);let d=new F(c),e=[];for(const[b,c]of Object.entries(a))void 0!==c.location&&e.push(b);return{out:e,program:d}}))}delete(){this.steps.forEach((a)=>{a.program.delete()}),this.steps.clear(),delete this.inputs,delete this.outputs,delete this.steps}exec(a={}){let b=[];for(const c of Object.values(this.outputs)){const a=[...c.dimensions];if(!b.length)b=a;else if(b[0]!=a[0]||b[1]!=a[1])throw new Error('Outputs require consistent sizes.')}let c=j.createFramebuffer();j.bindFramebuffer(j.FRAMEBUFFER,c);for(const c of this.steps){for(const[a,b]of c.out.entries()){const c=this.outputs[b]._getWritable(!0);j.framebufferTexture2D(j.FRAMEBUFFER,j.COLOR_ATTACHMENT0+a,j.TEXTURE_2D,c.id,0)}const{program:d}=c;j.useProgram(d.id),j.viewport(0,0,b[0],b[1]),d.setUniform('bl_Size',...b);for(const[b,c]of Object.entries(a))d.setUniform(b,c);for(const[a,b]of Object.keys(this.inputs).entries()){j.activeTexture(j.TEXTURE0+a);const c=this.inputs[b]._getReadable(!0);j.bindTexture(j.TEXTURE_2D,c.id),d.setUniform(b,a)}j.bindVertexArray(m),j.drawBuffers(c.out.map((a,b)=>j.COLOR_ATTACHMENT0+b)),j.drawArrays(j.TRIANGLE_STRIP,0,4),j.bindVertexArray(null);for(const[a,d]of c.out.entries()){const c=this.outputs[d];if(c instanceof B){const{bytes:d,format:e,type:f}=c.formatInfo;j.readBuffer(j.COLOR_ATTACHMENT0+a),j.readPixels(0,0,b[0],b[1],j[e],j[f],c.data,0)}}j.bindTexture(j.TEXTURE_2D,null)}const d=new Set([...Object.values(this.inputs),...Object.values(this.outputs)]);for(const b of d)b._finish();j.bindFramebuffer(j.FRAMEBUFFER,null),j.deleteFramebuffer(c)}},a.FLOAT=o,a.INT32=p,a.INT16=q,a.INT8=r,a.UINT32=s,a.UINT16=t,a.UINT8=u,a.CLAMP=v,a.MIRROR=33648,a.REPEAT=10497,Object.defineProperty(a,'__esModule',{value:!0})});
