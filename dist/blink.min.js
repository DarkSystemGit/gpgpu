var _Mathmin=Math.min,_Mathmax=Math.max;(function(b,c){'object'==typeof exports&&'undefined'!=typeof module?c(exports):'function'==typeof define&&define.amd?define(['exports'],c):c(b.blink=b.blink||{})})(this,function(b){'use strict';function c(J,K=1){const{bytes:L,integer:M,unsigned:N}=J,O=['lowp','mediump',null,'highp'][L-1],P=M&&N?'usampler2D':M?'isampler2D':'sampler2D';let Q=null;1==K?Q=M&&N?'uint':M?'int':'float':(Q=M&&N?'uvec':M?'ivec':'vec',Q+=K);let R=['R','RG','RGB','RGBA'][K-1];R+=8*L+'',R+=M&&N?'UI':M?'I':'F';let S=['RED','RG','RGB','RGBA'][K-1];S+=M?'_INTEGER':'';let T='';return M?(N&&(T='UNSIGNED_'),T+=1==L?'BYTE':2==L?'SHORT':'INT'):T='FLOAT',{bytes:L,format:S,internalFormat:R,inputType:P,integer:M,outputType:Q,precision:O,type:T,unsigned:N}}function d(J){let K=Math.floor(Math.sqrt(J));for(;J%K&&1<K;)K-=1;return[K,J/K]}function e(J){let K=j.getParameter(j.FRAMEBUFFER_BINDING),L=j.createFramebuffer();j.bindFramebuffer(j.FRAMEBUFFER,L),J(),j.bindFramebuffer(j.FRAMEBUFFER,K),j.deleteFramebuffer(L)}function f(J,K=null){const{bytes:L,internalFormat:M,format:N,type:O}=J.formatInfo,[P,Q]=J.dimensions;return new x(M,P,Q,N,O,K,L)}function g(J,K){/^#version 300 es/g.test(K)||(K='#version 300 es\n\r'+K);let L=j.createShader(J);if(j.shaderSource(L,K),j.compileShader(L),!j.getShaderParameter(L,j.COMPILE_STATUS)){const M=J==j.VERTEX_SHADER?'vertex':'fragment',N=j.getShaderInfoLog(L);throw new Error(`Unable to compile ${M} shader. Info log: 
			${N}`)}return L}function h(J,K,L){let M=Object.entries(J).map(([O,P])=>{const{inputType:Q,precision:R}=P.formatInfo;return`uniform ${R} ${Q} ${O};`}),N=Object.entries(K).map(([O,P])=>{const Q=P.location===void 0?'':`layout(location = ${P.location}) out `;return`${Q}${P.precision} ${P.outputType} ${O};`});return`${G}

		${M.join('\n\r')}

		${N.join('\n\r')}

		${L}`}const j=function(){const J=document.createElement('canvas');J.width=J.height=1;let L=J.getContext('webgl2',{alpha:!1,antialias:!1,depth:!1,stencil:!1});if(!L)throw new Error('WebGL 2.0 not supported by the browser.');else if(!(L.floatExt=L.getExtension('EXT_color_buffer_float')))throw new Error('EXT_color_buffer_float not supported.');return L.pixelStorei(L.PACK_ALIGNMENT,1),L.pixelStorei(L.UNPACK_ALIGNMENT,1),L}(),k=function(){let J={glslVersion:j.getParameter(j.SHADING_LANGUAGE_VERSION),maxColorAttachments:j.getParameter(j.MAX_DRAW_BUFFERS),maxTextureSize:j.getParameter(j.MAX_TEXTURE_SIZE),maxTextureUnits:j.getParameter(j.MAX_TEXTURE_IMAGE_UNITS),renderer:j.getParameter(j.RENDERER),vendor:j.getParameter(j.VENDOR)};const K=j.getExtension('WEBGL_debug_renderer_info');return K&&(J.unmaskedRenderer=j.getParameter(K.UNMASKED_RENDERER_WEBGL),J.unmaskedVendor=j.getParameter(K.UNMASKED_VENDOR_WEBGL)),Object.freeze(J)}(),l=function(){const J=new Float32Array([-1,1,-1,-1,1,1,1,-1]);let K=j.createBuffer();j.bindBuffer(j.ARRAY_BUFFER,K),j.bufferData(j.ARRAY_BUFFER,J,j.STATIC_DRAW),j.bindBuffer(j.ARRAY_BUFFER,null);let L=j.createVertexArray();return j.bindVertexArray(L),j.bindBuffer(j.ARRAY_BUFFER,K),j.enableVertexAttribArray(0),j.vertexAttribPointer(0,2,j.FLOAT,!1,0,0),j.bindVertexArray(null),j.bindBuffer(j.ARRAY_BUFFER,null),L}(),m=(J,K,L,M)=>Object.freeze({name:J,bytes:K,integer:L,unsigned:M}),n=m('float',4,!1,!1),o=m('int32',4,!0,!1),p=m('int16',2,!0,!1),q=m('int8',1,!0,!1),r=m('uint32',4,!0,!0),s=m('uint16',2,!0,!0),t=m('uint8',1,!0,!0),v=new Map([[n,Float32Array],[o,Int32Array],[p,Int16Array],[q,Int8Array],[r,Uint32Array],[s,Uint16Array],[t,Uint8Array]]),w={[Float32Array]:n,[Int32Array]:o,[Int16Array]:p,[Int8Array]:q,[Uint32Array]:r,[Uint16Array]:s,[Uint8Array]:t,[Uint8ClampedArray]:t};class x{constructor(J,K,L,M,N,O,P){const Q=j.getParameter(j.TEXTURE_BINDING_2D);this.internalFormat=J,this.width=K,this.height=L,this.format=M,this.type=N,this.alignment=P,this.id=j.createTexture(),j.bindTexture(j.TEXTURE_2D,this.id),j.texParameteri(j.TEXTURE_2D,j.TEXTURE_WRAP_S,j.CLAMP_TO_EDGE),j.texParameteri(j.TEXTURE_2D,j.TEXTURE_WRAP_T,j.CLAMP_TO_EDGE),j.texParameteri(j.TEXTURE_2D,j.TEXTURE_MIN_FILTER,j.NEAREST),j.texParameteri(j.TEXTURE_2D,j.TEXTURE_MAG_FILTER,j.NEAREST),j.texImage2D(j.TEXTURE_2D,0,j[this.internalFormat],K,L,0,j[this.format],j[this.type],O),j.bindTexture(j.TEXTURE_2D,Q)}delete(){j.getParameter(j.TEXTURE_BINDING_2D)==this.id&&j.bindTexture(j.TEXTURE_2D,null),j.deleteTexture(this.id),delete this.id}copy(){let J=new x(this.internalFormat,this.width,this.height,this.format,this.type,null,this.alignment);return e(()=>{j.framebufferTexture2D(j.FRAMEBUFFER,j.COLOR_ATTACHMENT0,j.TEXTURE_2D,this.id,0),j.readBuffer(j.COLOR_ATTACHMENT0),j.bindTexture(j.TEXTURE_2D,J.id),j.copyTexSubImage2D(j.TEXTURE_2D,0,0,0,0,0,this.width,this.height,0),j.bindTexture(j.TEXTURE_2D,null)}),J}upload(J){return j.bindTexture(j.TEXTURE_2D,this.id),j.texImage2D(j.TEXTURE_2D,0,j[this.internalFormat],this.width,this.height,0,j[this.format],j[this.type],J),j.bindTexture(j.TEXTURE_2D,this.id),this}read(J){return e(()=>{j.framebufferTexture2D(j.FRAMEBUFFER,j.COLOR_ATTACHMENT0,j.TEXTURE_2D,this.id,0),j.readBuffer(j.COLOR_ATTACHMENT0),j.readPixels(0,0,this.width,this.height,j[this.format],j[this.type],J,0)}),!0}}let y=new WeakMap,z=new WeakMap;class A{constructor({alloc:J,data:K,type:L=n,vector:M=1}){this.vector=_Mathmin(_Mathmax(M,1),4),3==this.vector&&(console.warn('Vector size of 3 not supported. Choosing vector size 4.'),this.vector=4);let N=J||K.length;this.dimensions=d(N/this.vector);const O=k.maxTextureSize**2;if(_Mathmax(...this.dimensions)>O)throw new Error('Buffer size exceeds device limit.');if(void 0!==J){const P=v.get(L);this.data=new P(N)}else this.data=K instanceof Uint8ClampedArray?new Uint8Array(K.buffer):K}delete(){delete this.data,this._finish()}copy(){return new A({data:new this.data.constructor(this.data),vector:this.vector})}get formatInfo(){const J=w[this.data.constructor];return c(J,this.vector)}_getReadable(J=!1){if(!y.has(this)&&J){const K=f(this,this.data);y.set(this,K)}return y.get(this)}_getWritable(J=!1){if(!z.has(this)&&J){const K=f(this,this.data);z.set(this,K)}return z.get(this)}_finish(){let J=this._getReadable();J&&(J.delete(),y.delete(this));let K=this._getWritable();K&&(K.delete(),z.delete(this))}}class B{constructor({alloc:J,data:K,type:L=n,vector:M=1}){this.vector=_Mathmin(_Mathmax(M,1),4),3==this.vector&&(console.warn('Vector size of 3 not supported. Choosing vector size 4.'),this.vector=4),this.size=J||K.length,this.dimensions=d(this.size/this.vector);const N=k.maxTextureSize**2;if(_Mathmax(...this.dimensions)>N)throw new Error('Buffer size exceeds device limit.');this.type=K?w[K.constructor]:L;let O=this._getReadable(!0);K&&(K.constructor==Uint8ClampedArray&&(K=new Uint8Array(K.buffer)),O.upload(K))}delete(){y.has(this)&&(y.get(this).delete(),y.delete(this))}copy(){let J=this._readable.copy(),K=new B({alloc:this.size,type:this.type,vector:this.vector});return K._readable.delete(),K._readable=J,K}toDevice(J){this._getReadable().upload(J)}toHost(J){if(!J){const K=v.get(this.type);J=new K(this.size)}return this._getReadable().read(J),J}get formatInfo(){return c(this.type,this.vector)}_getReadable(J=!1){if(!y.has(this)&&J){const{bytes:K,internalFormat:L,format:M,type:N}=this.formatInfo,[O,P]=this.dimensions;y.set(this,new x(L,O,P,M,N,null,K))}return y.get(this)}_getWritable(J=!1){return!z.has(this)&&J&&z.set(this,this._getReadable(!0).copy()),z.get(this)}_finish(){this._getReadable().delete(),y.set(this,this._getWritable()),z.delete(this)}}var C=`#version 300 es

precision highp float;

layout(location = 0) in vec2 pos;
out vec2 bl_UV;

void main() {
	gl_Position = vec4(pos, 0.0, 1.0);
	bl_UV = pos * 0.5 + 0.5;
}`;const D=g(j.VERTEX_SHADER,C);class E{constructor(J){let K=g(j.FRAGMENT_SHADER,J);if(this.id=j.createProgram(),j.attachShader(this.id,D),j.attachShader(this.id,K),j.deleteShader(K),j.linkProgram(this.id),!j.getProgramParameter(this.id,j.LINK_STATUS))return console.error('Unable to link program. Info log:'),console.warn(j.getProgramInfoLog(this.id)),null;this.attributes={};const L=j.getProgramParameter(this.id,j.ACTIVE_ATTRIBUTES);for(let N=0;N<L;N++){const O=j.getActiveAttrib(this.id,N);O.id=j.getAttribLocation(this.id,O.name),this.attributes[O.name]=O}this.uniforms={};const M=j.getProgramParameter(this.id,j.ACTIVE_UNIFORMS);for(let N=0;N<M;N++){const O=j.getActiveUniform(this.id,N);O.id=j.getUniformLocation(this.id,O.name),this.uniforms[O.name]=O}}delete(){j.deleteProgram(this.id),delete this.id}setUniform(J,...K){if(!this.uniforms[J])return;const{id:L,size:M,type:N}=this.uniforms[J];let O=F[N];1<M&&'v'!=O[O.length-1]&&(O+='v'),-1==O.indexOf('Matrix')?j[O](L,...K):j[O](L,!1,...K)}}const F={[j.FLOAT]:'uniform1f',[j.FLOAT_VEC_2]:'uniform2f',[j.FLOAT_VEC_3]:'uniform3f',[j.FLOAT_VEC_4]:'uniform4f',[j.INT]:'uniform1i',[j.INT_VEC2]:'uniform2i',[j.INT_VEC3]:'uniform3i',[j.INT_VEC4]:'uniform4i',[j.UNSIGNED_INT]:'uniform1ui',[j.UNSIGNED_INT_VEC2]:'uniform2ui',[j.UNSIGNED_INT_VEC3]:'uniform3ui',[j.UNSIGNED_INT_VEC4]:'uniform4ui',[j.BOOL]:'uniform1i',[j.BOOL_VEC2]:'uniform2i',[j.BOOL_VEC3]:'uniform3i',[j.BOOL_VEC4]:'uniform4i',[j.FLOAT_MAT2]:'uniformMatrix2fv',[j.FLOAT_MAT2x3]:'uniformMatrix2x3fv',[j.FLOAT_MAT2x4]:'uniformMatrix2x4fv',[j.FLOAT_MAT3]:'uniformMatrix3fv',[j.FLOAT_MAT3x2]:'uniformMatrix3x2fv',[j.FLOAT_MAT3x4]:'uniformMatrix3x4fv',[j.FLOAT_MAT4]:'uniformMatrix4fv',[j.FLOAT_MAT4x2]:'uniformMatrix4x2fv',[j.FLOAT_MAT4x3]:'uniformMatrix4x3fv',[j.SAMPLER_2D]:'uniform1i',[j.INT_SAMPLER_2D]:'uniform1i',[j.UNSIGNED_INT_SAMPLER_2D]:'uniform1i'};var G=`#version 300 es

precision highp float;
precision highp int;

uniform highp ivec2 bl_Size;

in vec2 bl_UV;

highp uint bl_Id() {
	highp ivec2 uv = ivec2(bl_UV * vec2(bl_Size));
	return uint(uv.x + uv.y * bl_Size.x);
}`;const I={major:0,minor:1,patch:2,toString(){return`${this.major}.${this.minor}.${this.patch}`}};b.VERSION=I,b.device=k,b.context=j,b.Buffer=A,b.DeviceBuffer=B,b.Kernel=class{constructor(J,K){if(this.inputs=J.in||J.input||J.inputs||{},this.outputs=J.out||J.output||J.outputs,!this.outputs||!Object.values(this.outputs).length)throw new Error(`At least 1 output is required.`);for(const R of Object.keys(this.outputs))for(const S of Object.keys(this.inputs))if(S===R)throw new Error(`Conflicting input/output variable name: ${S}.`);let L=Object.values(this.inputs).length;if(L>k.maxTextureUnits)throw new Error(`Maximum number of inputs exceeded. Allowed: ${k.maxTextureUnits}, given: ${L}.`);const M=k.maxColorAttachments,N=Object.keys(this.outputs),O=Math.ceil(N.length/M);let P=[],Q=0;for(let S,R=0;R<O;R++){S={};for(const[T,U]of N.entries()){const{outputType:V,precision:W}=this.outputs[U].formatInfo;S[U]={outputType:V,precision:W},T>=Q&&T<Q+M&&(S[U].location=T-Q)}P.push(S),Q+=M}this.steps=new Set(P.map((R)=>{const S=h(this.inputs,R,K);let T=new E(S),U=[];for(const[V,W]of Object.entries(R))void 0!==W.location&&U.push(V);return{out:U,program:T}}))}delete(){this.steps.forEach((J)=>{J.program.delete()}),this.steps.clear(),delete this.inputs,delete this.outputs,delete this.steps}exec(J={}){let K=[];for(const N of Object.values(this.outputs)){const O=[...N.dimensions];if(!K.length)K=O;else if(K[0]!=O[0]||K[1]!=O[1])throw new Error('Outputs require consistent sizes.')}let L=j.createFramebuffer();j.bindFramebuffer(j.FRAMEBUFFER,L);for(const N of this.steps){for(const[P,Q]of N.out.entries()){const R=this.outputs[Q]._getWritable(!0);j.framebufferTexture2D(j.FRAMEBUFFER,j.COLOR_ATTACHMENT0+P,j.TEXTURE_2D,R.id,0)}const{program:O}=N;j.useProgram(O.id),j.viewport(0,0,K[0],K[1]),O.setUniform('bl_Size',...K);for(const[P,Q]of Object.entries(J))O.setUniform(P,Q);for(const[P,Q]of Object.keys(this.inputs).entries()){j.activeTexture(j.TEXTURE0+P);const R=this.inputs[Q]._getReadable(!0);j.bindTexture(j.TEXTURE_2D,R.id),O.setUniform(Q,P)}j.bindVertexArray(l),j.drawBuffers(N.out.map((P,Q)=>j.COLOR_ATTACHMENT0+Q)),j.drawArrays(j.TRIANGLE_STRIP,0,4),j.bindVertexArray(null);for(const[P,Q]of N.out.entries()){const R=this.outputs[Q];if(R instanceof A){const{bytes:S,format:T,type:U}=R.formatInfo;j.readBuffer(j.COLOR_ATTACHMENT0+P),j.readPixels(0,0,K[0],K[1],j[T],j[U],R.data,0)}}j.bindTexture(j.TEXTURE_2D,null)}const M=[...Object.values(this.inputs),...Object.values(this.outputs)];for(const N of M)N._finish();j.bindFramebuffer(j.FRAMEBUFFER,null),j.deleteFramebuffer(L)}},b.FLOAT=n,b.INT32=o,b.INT16=p,b.INT8=q,b.UINT32=r,b.UINT16=s,b.UINT8=t,Object.defineProperty(b,'__esModule',{value:!0})});
