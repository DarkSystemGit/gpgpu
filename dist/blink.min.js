var _Mathmin=Math.min,_Mathmax=Math.max;(function(b,c){'object'==typeof exports&&'undefined'!=typeof module?c(exports):'function'==typeof define&&define.amd?define(['exports'],c):c(b.blink=b.blink||{})})(this,function(b){'use strict';function c(I,J=1){const{bytes:K,integer:L,unsigned:M}=I,N=['lowp','mediump',null,'highp'][K-1],O=L&&M?'usampler2D':L?'isampler2D':'sampler2D';let P=null;1==J?P=L&&M?'uint':L?'int':'float':(P=L&&M?'uvec':L?'ivec':'vec',P+=J);let Q=['R','RG','RGB','RGBA'][J-1];Q+=8*K,Q+=L&&M?'UI':L?'I':'F';let R=['RED','RG','RGB','RGBA'][J-1];R+=L?'_INTEGER':'';let S='';return L?(M&&(S='UNSIGNED_'),S+=1==K?'BYTE':2==K?'SHORT':'INT'):S='FLOAT',{bytes:K,format:R,internalFormat:Q,inputType:O,integer:L,outputType:P,precision:N,type:S,unsigned:M}}function d(I){let J=Math.floor(Math.sqrt(I));for(;I%J&&1<J;)J-=1;return[J,I/J]}function e(I){let J=j.getParameter(j.FRAMEBUFFER_BINDING),K=j.createFramebuffer();j.bindFramebuffer(j.FRAMEBUFFER,K),I(),j.bindFramebuffer(j.FRAMEBUFFER,J),j.deleteFramebuffer(K)}function f(I,J=null){const{bytes:K,internalFormat:L,format:M,type:N}=I.formatInfo,[O,P]=I.dimensions;return new w(L,O,P,M,N,J,K)}function g(I,J){/^#version 300 es/g.test(J)||(J='#version 300 es\n\r'+J);let K=j.createShader(I);if(j.shaderSource(K,J),j.compileShader(K),!j.getShaderParameter(K,j.COMPILE_STATUS)){const L=I==j.VERTEX_SHADER?'vertex':'fragment',M=j.getShaderInfoLog(K);throw new Error(`Unable to compile ${L} shader. Info log: 
			${M}`)}return K}function h(I,J,K){let L=Object.entries(I).map(([N,O])=>{const{inputType:P,precision:Q}=O.formatInfo;return`uniform ${Q} ${P} ${N};`}),M=Object.entries(J).map(([N,O])=>{const P=O.location===void 0?'':`layout(location = ${O.location}) out `;return`${P}${O.precision} ${O.outputType} ${N};`});return`${F}

		${L.join('\n\r')}

		${M.join('\n\r')}

		${K}`}const j=function(){const I=document.createElement('canvas');I.width=I.height=1;let K=I.getContext('webgl2',{alpha:!1,antialias:!1,depth:!1,stencil:!1});if(!K)throw new Error('WebGL 2.0 not supported by the browser.');else if(!(K.floatExt=K.getExtension('EXT_color_buffer_float')))throw new Error('EXT_color_buffer_float not supported.');return K.pixelStorei(K.PACK_ALIGNMENT,1),K.pixelStorei(K.UNPACK_ALIGNMENT,1),K}(),k=function(){let I={glslVersion:j.getParameter(j.SHADING_LANGUAGE_VERSION),maxColorAttachments:j.getParameter(j.MAX_DRAW_BUFFERS),maxTextureSize:j.getParameter(j.MAX_TEXTURE_SIZE),maxTextureUnits:j.getParameter(j.MAX_TEXTURE_IMAGE_UNITS),renderer:j.getParameter(j.RENDERER),vendor:j.getParameter(j.VENDOR)};const J=j.getExtension('WEBGL_debug_renderer_info');return J&&(I.unmaskedRenderer=j.getParameter(J.UNMASKED_RENDERER_WEBGL),I.unmaskedVendor=j.getParameter(J.UNMASKED_VENDOR_WEBGL)),Object.freeze(I)}(),l=function(){const I=new Float32Array([-1,1,-1,-1,1,1,1,-1]);let J=j.createBuffer();j.bindBuffer(j.ARRAY_BUFFER,J),j.bufferData(j.ARRAY_BUFFER,I,j.STATIC_DRAW),j.bindBuffer(j.ARRAY_BUFFER,null);let K=j.createVertexArray();return j.bindVertexArray(K),j.bindBuffer(j.ARRAY_BUFFER,J),j.enableVertexAttribArray(0),j.vertexAttribPointer(0,2,j.FLOAT,!1,0,0),j.bindVertexArray(null),j.bindBuffer(j.ARRAY_BUFFER,null),K}(),m=(I,J,K,L)=>Object.freeze({name:I,bytes:J,integer:K,unsigned:L}),n=m('float',4,!1,!1),o=m('int32',4,!0,!1),p=m('int16',2,!0,!1),q=m('int8',1,!0,!1),r=m('uint32',4,!0,!0),s=m('uint16',2,!0,!0),t=m('uint8',1,!0,!0),v=new Map([[n,Float32Array],[o,Int32Array],[p,Int16Array],[q,Int8Array],[r,Uint32Array],[s,Uint16Array],[t,Uint8Array]]);class w{constructor(I,J,K,L,M,N,O){const P=j.getParameter(j.TEXTURE_BINDING_2D);this.internalFormat=I,this.width=J,this.height=K,this.format=L,this.type=M,this.alignment=O,this.id=j.createTexture(),j.bindTexture(j.TEXTURE_2D,this.id),j.texParameteri(j.TEXTURE_2D,j.TEXTURE_WRAP_S,j.CLAMP_TO_EDGE),j.texParameteri(j.TEXTURE_2D,j.TEXTURE_WRAP_T,j.CLAMP_TO_EDGE),j.texParameteri(j.TEXTURE_2D,j.TEXTURE_MIN_FILTER,j.NEAREST),j.texParameteri(j.TEXTURE_2D,j.TEXTURE_MAG_FILTER,j.NEAREST),j.texImage2D(j.TEXTURE_2D,0,j[this.internalFormat],J,K,0,j[this.format],j[this.type],N),j.bindTexture(j.TEXTURE_2D,P)}delete(){j.getParameter(j.TEXTURE_BINDING_2D)==this.id&&j.bindTexture(j.TEXTURE_2D,null),j.deleteTexture(this.id),delete this.id}copy(){let I=new w(this.internalFormat,this.width,this.height,this.format,this.type,null,this.alignment);return e(()=>{j.framebufferTexture2D(j.FRAMEBUFFER,j.COLOR_ATTACHMENT0,j.TEXTURE_2D,this.id,0),j.readBuffer(j.COLOR_ATTACHMENT0),j.bindTexture(j.TEXTURE_2D,I.id),j.copyTexSubImage2D(j.TEXTURE_2D,0,0,0,0,0,this.width,this.height,0),j.bindTexture(j.TEXTURE_2D,null)}),I}upload(I){return j.bindTexture(j.TEXTURE_2D,this.id),j.texImage2D(j.TEXTURE_2D,0,j[this.internalFormat],this.width,this.height,0,j[this.format],j[this.type],I),j.bindTexture(j.TEXTURE_2D,this.id),this}read(I){return e(()=>{j.framebufferTexture2D(j.FRAMEBUFFER,j.COLOR_ATTACHMENT0,j.TEXTURE_2D,this.id,0),j.readBuffer(j.COLOR_ATTACHMENT0),j.readPixels(0,0,this.width,this.height,j[this.format],j[this.type],I,0)}),!0}}let x=new WeakMap,y=new WeakMap;class z{constructor({alloc:I,data:J,type:K=n,vector:L=1}){this.vector=_Mathmin(_Mathmax(L,1),4),3==this.vector&&(console.warn('Vector size of 3 not supported. Choosing vector size 4.'),this.vector=4);let M=I||J.length;this.dimensions=d(M/this.vector);const N=k.maxTextureSize**2;if(_Mathmax(...this.dimensions)>N)throw new Error('Buffer size exceeds device limit.');if(null!=I){const O=v.get(K);this.data=new O(M)}else this.data=J instanceof Uint8ClampedArray?new Uint8Array(J.buffer):J}delete(){delete this.data,this._finish()}copy(){return new z({data:new this.data.constructor(this.data),vector:this.vector})}get formatInfo(){for(const[I,J]of arrayTypes)if(this.data instanceof I)return c(J,this.vector);return null}_getReadable(I=!1){if(!x.has(this)&&I){const J=f(this,this.data);x.set(this,J)}return x.get(this)}_getWritable(I=!1){if(!y.has(this)&&I){const J=f(this,this.data);y.set(this,J)}return y.get(this)}_finish(){let I=this._getReadable();I&&(I.delete(),x.delete(this));let J=this._getWritable();J&&(J.delete(),y.delete(this))}}class A{constructor({alloc:I,data:J,type:K=n,vector:L=1}){this.vector=_Mathmin(_Mathmax(L,1),4),3==this.vector&&(console.warn('Vector size of 3 not supported. Choosing vector size 4.'),this.vector=4),this.size=I||J.length,this.dimensions=d(this.size/this.vector);const M=k.maxTextureSize**2;if(_Mathmax(...this.dimensions)>M)throw new Error('Buffer size exceeds device limit.');let N=K;if(J)for(const[P,Q]of arrayTypes)J instanceof P&&(N=Q);this.type=N;let O=this._getReadable(!0);J&&(J.constructor==Uint8ClampedArray&&(J=new Uint8Array(J.buffer)),O.upload(J))}delete(){x.has(this)&&(x.get(this).delete(),x.delete(this))}copy(){let I=this._readable.copy(),J=new A({alloc:this.size,type:this.type,vector:this.vector});return J._readable.delete(),J._readable=I,J}toDevice(I){this._getReadable().upload(I)}toHost(I){if(!I){const J=v.get(this.type);I=new J(this.size)}return this._getReadable().read(I),I}get formatInfo(){return c(this.type,this.vector)}_getReadable(I=!1){if(!x.has(this)&&I){const{bytes:J,internalFormat:K,format:L,type:M}=this.formatInfo,[N,O]=this.dimensions;x.set(this,new w(K,N,O,L,M,null,J))}return x.get(this)}_getWritable(I=!1){return!y.has(this)&&I&&y.set(this,this._getReadable(!0).copy()),y.get(this)}_finish(){this._getReadable().delete(),x.set(this,this._getWritable()),y.delete(this)}}var B=`#version 300 es

precision highp float;

layout(location = 0) in vec2 pos;
out vec2 bl_UV;

void main() {
	gl_Position = vec4(pos, 0.0, 1.0);
	bl_UV = pos * 0.5 + 0.5;
}`;const C=g(j.VERTEX_SHADER,B);class D{constructor(I){let J=g(j.FRAGMENT_SHADER,I);if(this.id=j.createProgram(),j.attachShader(this.id,C),j.attachShader(this.id,J),j.deleteShader(J),j.linkProgram(this.id),!j.getProgramParameter(this.id,j.LINK_STATUS))return console.error('Unable to link program. Info log:'),console.warn(j.getProgramInfoLog(this.id)),null;this.attributes={};const K=j.getProgramParameter(this.id,j.ACTIVE_ATTRIBUTES);for(let N,M=0;M<K;M++)N=j.getActiveAttrib(this.id,M),N.id=j.getAttribLocation(this.id,N.name),this.attributes[N.name]=N;this.uniforms={};const L=j.getProgramParameter(this.id,j.ACTIVE_UNIFORMS);for(let N,M=0;M<L;M++)N=j.getActiveUniform(this.id,M),N.id=j.getUniformLocation(this.id,N.name),this.uniforms[N.name]=N}delete(){j.deleteProgram(this.id),delete this.id}setUniform(I,...J){if(!this.uniforms[I])return;const{id:K,size:L,type:M}=this.uniforms[I];let N=E[M];1<L&&'v'!=N[N.length-1]&&(N+='v'),-1==N.indexOf('Matrix')?j[N](K,...J):j[N](K,!1,...J)}}const E={[j.FLOAT]:'uniform1f',[j.FLOAT_VEC_2]:'uniform2f',[j.FLOAT_VEC_3]:'uniform3f',[j.FLOAT_VEC_4]:'uniform4f',[j.INT]:'uniform1i',[j.INT_VEC2]:'uniform2i',[j.INT_VEC3]:'uniform3i',[j.INT_VEC4]:'uniform4i',[j.UNSIGNED_INT]:'uniform1ui',[j.UNSIGNED_INT_VEC2]:'uniform2ui',[j.UNSIGNED_INT_VEC3]:'uniform3ui',[j.UNSIGNED_INT_VEC4]:'uniform4ui',[j.BOOL]:'uniform1i',[j.BOOL_VEC2]:'uniform2i',[j.BOOL_VEC3]:'uniform3i',[j.BOOL_VEC4]:'uniform4i',[j.FLOAT_MAT2]:'uniformMatrix2fv',[j.FLOAT_MAT2x3]:'uniformMatrix2x3fv',[j.FLOAT_MAT2x4]:'uniformMatrix2x4fv',[j.FLOAT_MAT3]:'uniformMatrix3fv',[j.FLOAT_MAT3x2]:'uniformMatrix3x2fv',[j.FLOAT_MAT3x4]:'uniformMatrix3x4fv',[j.FLOAT_MAT4]:'uniformMatrix4fv',[j.FLOAT_MAT4x2]:'uniformMatrix4x2fv',[j.FLOAT_MAT4x3]:'uniformMatrix4x3fv',[j.SAMPLER_2D]:'uniform1i',[j.INT_SAMPLER_2D]:'uniform1i',[j.UNSIGNED_INT_SAMPLER_2D]:'uniform1i'};var F=`#version 300 es

precision highp float;
precision highp int;

uniform highp ivec2 bl_Size;

in vec2 bl_UV;

highp uint bl_Id() {
	highp ivec2 uv = ivec2(bl_UV * vec2(bl_Size));
	return uint(uv.x + uv.y * bl_Size.x);
}`;const H={major:0,minor:2,patch:0,toString(){return`${this.major}.${this.minor}.${this.patch}`}};b.VERSION=H,b.device=k,b.context=j,b.Buffer=z,b.DeviceBuffer=A,b.Kernel=class{constructor(I,J){if(this.inputs=I.in||I.input||I.inputs||{},this.outputs=I.out||I.output||I.outputs,!this.outputs||!Object.values(this.outputs).length)throw new Error(`At least 1 output is required.`);for(const Q of Object.keys(this.outputs))for(const R of Object.keys(this.inputs))if(R===Q)throw new Error(`Conflicting input/output variable name: ${R}.`);let K=Object.values(this.inputs).length;if(K>k.maxTextureUnits)throw new Error(`Maximum number of inputs exceeded. Allowed: ${k.maxTextureUnits}, given: ${K}.`);const L=k.maxColorAttachments,M=Object.keys(this.outputs),N=Math.ceil(M.length/L);let O=[],P=0;for(let R,Q=0;Q<N;Q++){R={};for(const[S,T]of M.entries()){const{outputType:U,precision:V}=this.outputs[T].formatInfo;R[T]={outputType:U,precision:V},S>=P&&S<P+L&&(R[T].location=S-P)}O.push(R),P+=L}this.steps=new Set(O.map((Q)=>{const R=h(this.inputs,Q,J);let S=new D(R),T=[];for(const[U,V]of Object.entries(Q))void 0!==V.location&&T.push(U);return{out:T,program:S}}))}delete(){this.steps.forEach((I)=>{I.program.delete()}),this.steps.clear(),delete this.inputs,delete this.outputs,delete this.steps}exec(I={}){let J=[];for(const M of Object.values(this.outputs)){const N=[...M.dimensions];if(!J.length)J=N;else if(J[0]!=N[0]||J[1]!=N[1])throw new Error('Outputs require consistent sizes.')}let K=j.createFramebuffer();j.bindFramebuffer(j.FRAMEBUFFER,K);for(const M of this.steps){for(const[O,P]of M.out.entries()){const Q=this.outputs[P]._getWritable(!0);j.framebufferTexture2D(j.FRAMEBUFFER,j.COLOR_ATTACHMENT0+O,j.TEXTURE_2D,Q.id,0)}const{program:N}=M;j.useProgram(N.id),j.viewport(0,0,J[0],J[1]),N.setUniform('bl_Size',...J);for(const[O,P]of Object.entries(I))N.setUniform(O,P);for(const[O,P]of Object.keys(this.inputs).entries()){j.activeTexture(j.TEXTURE0+O);const Q=this.inputs[P]._getReadable(!0);j.bindTexture(j.TEXTURE_2D,Q.id),N.setUniform(P,O)}j.bindVertexArray(l),j.drawBuffers(M.out.map((O,P)=>j.COLOR_ATTACHMENT0+P)),j.drawArrays(j.TRIANGLE_STRIP,0,4),j.bindVertexArray(null);for(const[O,P]of M.out.entries()){const Q=this.outputs[P];if(Q instanceof z){const{bytes:R,format:S,type:T}=Q.formatInfo;j.readBuffer(j.COLOR_ATTACHMENT0+O),j.readPixels(0,0,J[0],J[1],j[S],j[T],Q.data,0)}}j.bindTexture(j.TEXTURE_2D,null)}const L=[...Object.values(this.inputs),...Object.values(this.outputs)];for(const M of L)M._finish();j.bindFramebuffer(j.FRAMEBUFFER,null),j.deleteFramebuffer(K)}},b.FLOAT=n,b.INT32=o,b.INT16=p,b.INT8=q,b.UINT32=r,b.UINT16=s,b.UINT8=t,Object.defineProperty(b,'__esModule',{value:!0})});
