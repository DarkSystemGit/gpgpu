var _Mathmin=Math.min,_Mathmax=Math.max;(function(b,c){'object'==typeof exports&&'undefined'!=typeof module?c(exports):'function'==typeof define&&define.amd?define(['exports'],c):c(b.blink=b.blink||{})})(this,function(b){'use strict';function c(M,N=1){const{bytes:O,integer:P,unsigned:Q}=M,R=['lowp','mediump',null,'highp'][O-1],S=P&&Q?'usampler2D':P?'isampler2D':'sampler2D';let T=null;1==N?T=P&&Q?'uint':P?'int':'float':(T=P&&Q?'uvec':P?'ivec':'vec',T+=N);let U=['R','RG','RGB','RGBA'][N-1];U+=8*O,U+=P&&Q?'UI':P?'I':'F';let V=['RED','RG','RGB','RGBA'][N-1];V+=P?'_INTEGER':'';let W='';return P?(Q&&(W='UNSIGNED_'),W+=1==O?'BYTE':2==O?'SHORT':'INT'):W='FLOAT',{bytes:O,format:V,internalFormat:U,inputType:S,integer:P,outputType:T,precision:R,type:W,unsigned:Q}}function d(M){let N=Math.floor(Math.sqrt(M));for(;M%N&&1<N;)N-=1;return[N,M/N]}function e(M){let N=j.getParameter(j.FRAMEBUFFER_BINDING),O=j.createFramebuffer();j.bindFramebuffer(j.FRAMEBUFFER,O),M(),j.bindFramebuffer(j.FRAMEBUFFER,N),j.deleteFramebuffer(O)}function f(M,N=null){const{bytes:P,internalFormat:Q,format:R,type:S}=M.formatInfo,[T,U]=M.dimensions;return new A(Q,T,U,R,S,N,P,...M.wrap)}function g(M,N){/^#version 300 es/g.test(N)||(N='#version 300 es\n\r'+N);let O=j.createShader(M);if(j.shaderSource(O,N),j.compileShader(O),!j.getShaderParameter(O,j.COMPILE_STATUS)){const P=M==j.VERTEX_SHADER?'vertex':'fragment',Q=j.getShaderInfoLog(O);throw new Error(`Unable to compile ${P} shader. Info log: 
			${Q}`)}return O}function h(M,N,O){let P=Object.entries(M).map(([R,S])=>{const{inputType:T,precision:U}=S.formatInfo;return`uniform ${U} ${T} ${R};`}),Q=Object.entries(N).map(([R,S])=>{const T=S.location===void 0?'':`layout(location = ${S.location}) out `;return`${T}${S.precision} ${S.outputType} ${R};`});return`${J}

		${P.join('\n\r')}

		${Q.join('\n\r')}

		${O}`}const j=function(){const M=document.createElement('canvas');M.width=M.height=1;let O=M.getContext('webgl2',{alpha:!1,antialias:!1,depth:!1,stencil:!1});if(!O)throw new Error('WebGL 2.0 not supported by the browser.');else if(!(O.floatExt=O.getExtension('EXT_color_buffer_float')))throw new Error('EXT_color_buffer_float not supported.');return O.pixelStorei(O.PACK_ALIGNMENT,1),O.pixelStorei(O.UNPACK_ALIGNMENT,1),O}(),k=function(){let M={glslVersion:j.getParameter(j.SHADING_LANGUAGE_VERSION),maxColorAttachments:j.getParameter(j.MAX_DRAW_BUFFERS),maxTextureSize:j.getParameter(j.MAX_TEXTURE_SIZE),maxTextureUnits:j.getParameter(j.MAX_TEXTURE_IMAGE_UNITS),renderer:j.getParameter(j.RENDERER),vendor:j.getParameter(j.VENDOR)};const N=j.getExtension('WEBGL_debug_renderer_info');return N&&(M.unmaskedRenderer=j.getParameter(N.UNMASKED_RENDERER_WEBGL),M.unmaskedVendor=j.getParameter(N.UNMASKED_VENDOR_WEBGL)),Object.freeze(M)}(),l=function(){const M=new Float32Array([-1,1,-1,-1,1,1,1,-1]);let N=j.createBuffer();j.bindBuffer(j.ARRAY_BUFFER,N),j.bufferData(j.ARRAY_BUFFER,M,j.STATIC_DRAW),j.bindBuffer(j.ARRAY_BUFFER,null);let O=j.createVertexArray();return j.bindVertexArray(O),j.bindBuffer(j.ARRAY_BUFFER,N),j.enableVertexAttribArray(0),j.vertexAttribPointer(0,2,j.FLOAT,!1,0,0),j.bindVertexArray(null),j.bindBuffer(j.ARRAY_BUFFER,null),O}(),m=(M,N,O,P)=>Object.freeze({name:M,bytes:N,integer:O,unsigned:P}),n=m('float',4,!1,!1),o=m('int32',4,!0,!1),p=m('int16',2,!0,!1),q=m('int8',1,!0,!1),r=m('uint32',4,!0,!0),s=m('uint16',2,!0,!0),t=m('uint8',1,!0,!0),v=33071,y=new Map([[n,Float32Array],[o,Int32Array],[p,Int16Array],[q,Int8Array],[r,Uint32Array],[s,Uint16Array],[t,Uint8Array]]),z=new Map([[Float32Array,n],[Int32Array,o],[Int16Array,p],[Int8Array,q],[Uint32Array,r],[Uint16Array,s],[Uint8Array,t],[Uint8ClampedArray,t]]);class A{constructor(M,N,O,P,Q,R,S,T,U){const V=j.getParameter(j.TEXTURE_BINDING_2D);this.internalFormat=M,this.width=N,this.height=O,this.format=P,this.type=Q,this.alignment=S,this.id=j.createTexture(),j.bindTexture(j.TEXTURE_2D,this.id),j.texParameteri(j.TEXTURE_2D,j.TEXTURE_WRAP_S,T||j.CLAMP_TO_EDGE),j.texParameteri(j.TEXTURE_2D,j.TEXTURE_WRAP_T,U||j.CLAMP_TO_EDGE),j.texParameteri(j.TEXTURE_2D,j.TEXTURE_MIN_FILTER,j.NEAREST),j.texParameteri(j.TEXTURE_2D,j.TEXTURE_MAG_FILTER,j.NEAREST),j.texImage2D(j.TEXTURE_2D,0,j[this.internalFormat],N,O,0,j[this.format],j[this.type],R),j.bindTexture(j.TEXTURE_2D,V)}delete(){j.getParameter(j.TEXTURE_BINDING_2D)==this.id&&j.bindTexture(j.TEXTURE_2D,null),j.deleteTexture(this.id),delete this.id}copy(){let M=new A(this.internalFormat,this.width,this.height,this.format,this.type,null,this.alignment);return e(()=>{j.framebufferTexture2D(j.FRAMEBUFFER,j.COLOR_ATTACHMENT0,j.TEXTURE_2D,this.id,0),j.readBuffer(j.COLOR_ATTACHMENT0),j.bindTexture(j.TEXTURE_2D,M.id),j.copyTexSubImage2D(j.TEXTURE_2D,0,0,0,0,0,this.width,this.height,0),j.bindTexture(j.TEXTURE_2D,null)}),M}upload(M){return j.bindTexture(j.TEXTURE_2D,this.id),j.texImage2D(j.TEXTURE_2D,0,j[this.internalFormat],this.width,this.height,0,j[this.format],j[this.type],M),j.bindTexture(j.TEXTURE_2D,null),this}read(M){return e(()=>{j.framebufferTexture2D(j.FRAMEBUFFER,j.COLOR_ATTACHMENT0,j.TEXTURE_2D,this.id,0),j.readBuffer(j.COLOR_ATTACHMENT0),j.readPixels(0,0,this.width,this.height,j[this.format],j[this.type],M,0)}),!0}}let B=new WeakMap,C=new WeakMap;class D{constructor({alloc:M,data:N,type:O=n,vector:P=1,wrap:Q=v}){this.vector=_Mathmin(_Mathmax(P,1),4),3==this.vector&&(console.warn('Vector size of 3 not supported. Choosing vector size 4.'),this.vector=4);let R=M||N.length;this.dimensions=d(R/this.vector),this.wrap=Array.isArray(Q)?Q:[Q,Q];const S=k.maxTextureSize**2;if(_Mathmax(...this.dimensions)>S)throw new Error('Buffer size exceeds device limit.');if(null!=M){const T=y.get(O);this.data=new T(R)}else this.data=N instanceof Uint8ClampedArray?new Uint8Array(N.buffer):N}delete(){delete this.data,this._finish()}copy(){return new D({data:new this.data.constructor(this.data),vector:this.vector})}get formatInfo(){for(const[M,N]of z)if(this.data instanceof M)return c(N,this.vector);return null}_getReadable(M=!1){if(!B.has(this)&&M){const N=f(this,this.data);B.set(this,N)}return B.get(this)}_getWritable(M=!1){if(!C.has(this)&&M){const N=f(this,this.data);C.set(this,N)}return C.get(this)}_finish(){let M=this._getReadable();M&&(M.delete(),B.delete(this));let N=this._getWritable();N&&(N.delete(),C.delete(this))}}class E{constructor({alloc:M,data:N,type:O=n,vector:P=1,wrap:Q=v}){this.vector=_Mathmin(_Mathmax(P,1),4),3==this.vector&&(console.warn('Vector size of 3 not supported. Choosing vector size 4.'),this.vector=4),this.size=M||N.length,this.dimensions=d(this.size/this.vector),this.wrap=Array.isArray(Q)?Q:[Q,Q];const R=k.maxTextureSize**2;if(_Mathmax(...this.dimensions)>R)throw new Error('Buffer size exceeds device limit.');let S=O;if(N)for(const[U,V]of z)if(N instanceof U){S=V;break}this.type=S;let T=this._getReadable(!0);N&&(N.constructor==Uint8ClampedArray&&(N=new Uint8Array(N.buffer)),T.upload(N))}delete(){B.has(this)&&(B.get(this).delete(),B.delete(this))}copy(){let M=this._readable.copy(),N=new E({alloc:this.size,type:this.type,vector:this.vector});return N._readable.delete(),N._readable=M,N}toDevice(M){this._getReadable().upload(M)}toHost(M){if(!M){const O=y.get(this.type);M=new O(this.size)}let N=M;return M instanceof Uint8ClampedArray&&(N=new Uint8Array(M.buffer)),this._getReadable().read(N),M}get formatInfo(){return c(this.type,this.vector)}_getReadable(M=!1){if(!B.has(this)&&M){const{bytes:N,internalFormat:O,format:P,type:Q}=this.formatInfo,[R,S]=this.dimensions;B.set(this,new A(O,R,S,P,Q,null,N,...this.wrap))}return B.get(this)}_getWritable(M=!1){return!C.has(this)&&M&&C.set(this,this._getReadable(!0).copy()),C.get(this)}_finish(){let M=this._getWritable();if(M){let N=this._getReadable();N&&N.delete(),B.set(this,M),C.delete(this)}}}var F=`#version 300 es

precision highp float;

layout(location = 0) in vec2 pos;
out vec2 bl_UV;

void main() {
	gl_Position = vec4(pos, 0.0, 1.0);
	bl_UV = pos * 0.5 + 0.5;
}`;const G=g(j.VERTEX_SHADER,F);class H{constructor(M){let N=g(j.FRAGMENT_SHADER,M);if(this.id=j.createProgram(),j.attachShader(this.id,G),j.attachShader(this.id,N),j.deleteShader(N),j.linkProgram(this.id),!j.getProgramParameter(this.id,j.LINK_STATUS))return console.error('Unable to link program. Info log:'),console.warn(j.getProgramInfoLog(this.id)),null;this.attributes={};const O=j.getProgramParameter(this.id,j.ACTIVE_ATTRIBUTES);for(let R,Q=0;Q<O;Q++)R=j.getActiveAttrib(this.id,Q),R.id=j.getAttribLocation(this.id,R.name),this.attributes[R.name]=R;this.uniforms={};const P=j.getProgramParameter(this.id,j.ACTIVE_UNIFORMS);for(let R,Q=0;Q<P;Q++)R=j.getActiveUniform(this.id,Q),R.id=j.getUniformLocation(this.id,R.name),this.uniforms[R.name]=R}delete(){j.deleteProgram(this.id),delete this.id}setUniform(M,...N){if(!this.uniforms[M])return;const{id:O,size:P,type:Q}=this.uniforms[M];let R=I[Q];1<P&&'v'!=R[R.length-1]&&(R+='v'),-1==R.indexOf('Matrix')?j[R](O,...N):j[R](O,!1,...N)}}const I={[j.FLOAT]:'uniform1f',[j.FLOAT_VEC2]:'uniform2f',[j.FLOAT_VEC3]:'uniform3f',[j.FLOAT_VEC4]:'uniform4f',[j.INT]:'uniform1i',[j.INT_VEC2]:'uniform2i',[j.INT_VEC3]:'uniform3i',[j.INT_VEC4]:'uniform4i',[j.UNSIGNED_INT]:'uniform1ui',[j.UNSIGNED_INT_VEC2]:'uniform2ui',[j.UNSIGNED_INT_VEC3]:'uniform3ui',[j.UNSIGNED_INT_VEC4]:'uniform4ui',[j.BOOL]:'uniform1i',[j.BOOL_VEC2]:'uniform2i',[j.BOOL_VEC3]:'uniform3i',[j.BOOL_VEC4]:'uniform4i',[j.FLOAT_MAT2]:'uniformMatrix2fv',[j.FLOAT_MAT2x3]:'uniformMatrix2x3fv',[j.FLOAT_MAT2x4]:'uniformMatrix2x4fv',[j.FLOAT_MAT3]:'uniformMatrix3fv',[j.FLOAT_MAT3x2]:'uniformMatrix3x2fv',[j.FLOAT_MAT3x4]:'uniformMatrix3x4fv',[j.FLOAT_MAT4]:'uniformMatrix4fv',[j.FLOAT_MAT4x2]:'uniformMatrix4x2fv',[j.FLOAT_MAT4x3]:'uniformMatrix4x3fv',[j.SAMPLER_2D]:'uniform1i',[j.INT_SAMPLER_2D]:'uniform1i',[j.UNSIGNED_INT_SAMPLER_2D]:'uniform1i'};var J=`#version 300 es

precision highp float;
precision highp int;

uniform highp ivec2 bl_Size;

in vec2 bl_UV;

highp uint bl_Id() {
	highp ivec2 uv = ivec2(bl_UV * vec2(bl_Size));
	return uint(uv.x + uv.y * bl_Size.x);
}`;const L={major:0,minor:2,patch:4,toString(){return`${this.major}.${this.minor}.${this.patch}`}};b.VERSION=L,b.device=k,b.context=j,b.Buffer=D,b.DeviceBuffer=E,b.Kernel=class{constructor(M,N){if(this.inputs=M.in||M.input||M.inputs||{},this.outputs=M.out||M.output||M.outputs,!this.outputs||!Object.values(this.outputs).length)throw new Error(`At least 1 output is required.`);for(const U of Object.keys(this.outputs))for(const V of Object.keys(this.inputs))if(V===U)throw new Error(`Conflicting input/output variable name: ${V}.`);let O=Object.values(this.inputs).length;if(O>k.maxTextureUnits)throw new Error(`Maximum number of inputs exceeded. Allowed: ${k.maxTextureUnits}, given: ${O}.`);const P=k.maxColorAttachments,Q=Object.keys(this.outputs),R=Math.ceil(Q.length/P);let S=[],T=0;for(let V,U=0;U<R;U++){V={};for(const[W,X]of Q.entries()){const{outputType:Y,precision:Z}=this.outputs[X].formatInfo;V[X]={outputType:Y,precision:Z},W>=T&&W<T+P&&(V[X].location=W-T)}S.push(V),T+=P}this.steps=new Set(S.map((U)=>{const V=h(this.inputs,U,N);let W=new H(V),X=[];for(const[Y,Z]of Object.entries(U))void 0!==Z.location&&X.push(Y);return{out:X,program:W}}))}delete(){this.steps.forEach((M)=>{M.program.delete()}),this.steps.clear(),delete this.inputs,delete this.outputs,delete this.steps}exec(M={}){let N=[];for(const Q of Object.values(this.outputs)){const R=[...Q.dimensions];if(!N.length)N=R;else if(N[0]!=R[0]||N[1]!=R[1])throw new Error('Outputs require consistent sizes.')}let O=j.createFramebuffer();j.bindFramebuffer(j.FRAMEBUFFER,O);for(const Q of this.steps){for(const[S,T]of Q.out.entries()){const U=this.outputs[T]._getWritable(!0);j.framebufferTexture2D(j.FRAMEBUFFER,j.COLOR_ATTACHMENT0+S,j.TEXTURE_2D,U.id,0)}const{program:R}=Q;j.useProgram(R.id),j.viewport(0,0,N[0],N[1]),R.setUniform('bl_Size',...N);for(const[S,T]of Object.entries(M))R.setUniform(S,T);for(const[S,T]of Object.keys(this.inputs).entries()){j.activeTexture(j.TEXTURE0+S);const U=this.inputs[T]._getReadable(!0);j.bindTexture(j.TEXTURE_2D,U.id),R.setUniform(T,S)}j.bindVertexArray(l),j.drawBuffers(Q.out.map((S,T)=>j.COLOR_ATTACHMENT0+T)),j.drawArrays(j.TRIANGLE_STRIP,0,4),j.bindVertexArray(null);for(const[S,T]of Q.out.entries()){const U=this.outputs[T];if(U instanceof D){const{bytes:V,format:W,type:X}=U.formatInfo;j.readBuffer(j.COLOR_ATTACHMENT0+S),j.readPixels(0,0,N[0],N[1],j[W],j[X],U.data,0)}}j.bindTexture(j.TEXTURE_2D,null)}const P=new Set([...Object.values(this.inputs),...Object.values(this.outputs)]);for(const Q of P)Q._finish();j.bindFramebuffer(j.FRAMEBUFFER,null),j.deleteFramebuffer(O)}},b.FLOAT=n,b.INT32=o,b.INT16=p,b.INT8=q,b.UINT32=r,b.UINT16=s,b.UINT8=t,b.CLAMP=v,b.REPEAT=10497,b.MIRROR=33648,Object.defineProperty(b,'__esModule',{value:!0})});
